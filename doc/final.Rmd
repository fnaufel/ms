---
title: 'Estratégias para a Mega-sena'
author: 'fnaufel'
email: 'https://fnaufel.github.io/'
date: 'Versão de `r format(Sys.Date(), "%d/%m/%Y")`'
lang: 'pt'
# TODO: include LaTeX fields
output: 
  html_document:
    theme: readable
           # https://bootswatch.com/3/readable/
    highlight: tango
    css: styles.css
    toc: true
    toc_depth: 2
    number_sections: true
    fig_caption: true
    df_print: paged
    self_contained: true
    # code_folding: show
    # keep_md: true
    # includes:
    #   in_header: header.html
    #   before_body: doc_prefix.html
    #   after_body: doc_suffix.html
---

```{r setup, include=FALSE}
library(knitr)

opts_chunk$set(
  echo = FALSE, 
  # collapse = TRUE,
  # cache = TRUE,
  out.width = "75%",
  fig.align = 'center',
  fig.width = 6,
  fig.show = "hold"
)

options(dplyr.print_min = 6, dplyr.print_max = 6)

# Supress crayon output
options(crayon.enabled = FALSE)

#library()

# For nice tables
# library(gt)

# For nice dataframe summaries
library(summarytools)
st_options(
  plain.ascii = FALSE,
  dfSummary.varnumbers = FALSE,
  dfSummary.style = 'grid',
  dfSummary.graph.magnif = .75
)

# Tidy!
library(tidyverse)

# Sober theme for ggplot
theme_set(
  theme_linedraw() +                         # Set simple theme for ggplot
    theme(                                   # with some tweaks
      axis.title.y.left = element_text(
         angle = 0,                          # Never rotate y axis title
         margin = margin(r = 20),            # Separate y axis title a little 
         vjust = .5                          # Leave y axis title in the middle
      ),
      axis.title.x.bottom = element_text(
         margin = margin(t = 20)             # Separate x axis title a little 
      ),
      axis.line = element_blank(),           # No axis lines
      panel.border = element_blank(),        # No frame
      panel.grid.minor = element_blank()     # No grid minor lines
    )
)

# Avoid scientific notation and use a comma as decimal separator
options(
  scipen = 15,
  OutDec = ','
)

# Format a number with thousand separators (default point)
# and decimal comma enclosed in curly braces for LaTeX printing.
# CAREFUL: if called outside math mode, will print the braces!
fm <- function(x, big = '.', decimal = '{,}') {
  if (!is.numeric(x)) {
    x
  } else {
    prettyNum(x, big.mark = big, decimal.mark = decimal)
  }

}

# To center the results of a chunk (image, video etc.)
# Usage: 
#         out.extra=center()
#         
center <- function(){
  
  if (is_html_output()) {
    'class="center"'
  }
  
}


# To embed YT videos in HTML and the link (centered) in LaTeX
embed_yt <- function(code) {

  if (is_html_output()) {
    include_url(
      paste0(
        'https://www.youtube.com/embed/',
        code
      )
    )
  } else {
    cat(
      paste0(
        '```{=latex}\n',
        '\\begin{center} \\url{https://youtu.be/',
        code,
        '} \\end{center}\n',
        '```'
      )
    )
  }
  
}

source('../packages.R')
```

```{js javascript-init, echo=FALSE}

// Make off-site links open in a new window/tab
function changeTargets() {
  $("a").attr(
    "target", function() {
      // Load local links locally
      if (this.host == location.host) return "_self"
      // Load off-site links in a new window
      else return "_blank";
    }
  );
}

// Execute when document is ready
$(
  changeTargets
)
```

# Introdução

???

Dados de http://www1.caixa.gov.br/loterias/_arquivos/loterias/D_mgsasc.zip

???

# Dicionário

```{r echo=FALSE, message=FALSE}
loadd(df_summary)
```

`num`

  : número do concurso

`data`

  : data do concurso

`d1 ... d5`

  : dezenas sorteadas
  
`arrec`

  : arrecadação total
  
`g_sena, g_quina, g_quadra`

  : quantidades de ganhadores
  
`r_sena, r_quina, r_quadra`

  : rateios para cada faixa, i.e., valor de cada prêmio *individual* na faixa
  
`acumulou`

  : `true` se o prêmio da sena acumulou
  
`valor_ac`

  : valor acumulado
  
`est_prox`

  : estimativa do prêmio *total* da sena no próximo concurso
  
`ac_virada`

  : valor acumulado até agora para a mega-sena da virada
  

# Estratégias que não funcionam

## Dezenas mais raras

## Dezenas mais frequentes

## Dezenas pares, ímpares, em quadrantes, etc.


# Estratégias que funcionam


# Probabilidades

# Estimativas

## Corrigindo a estimativa de arrecadação da CEF

```{r}
loadd(arrec_resultados, n_recentes, rsq_CEF)

previsoes <- arrec_resultados$validacao
modelo <- arrec_resultados$modelo %>% pull_workflow_fit()

b0 <- modelo$fit$coefficients[1] %>% round(2) %>% fm()
b1 <- modelo$fit$coefficients[2] %>% round(2) %>% fm()

n_previsoes <- nrow(previsoes)
rsq <- previsoes %>% 
  metrics(truth = arrec, estimate = .pred) %>% 
  filter(.metric == 'rsq') %>% 
  pull(.estimate)
```

Após cada concurso, a CEF faz uma estimativa da arrecadação do concurso seguinte. Examinando os dados, vemos que essas estimativas costumam ficar abaixo dos valores reais.

Usamos regressão linear para construir um modelo da arrecadação real em função da estimativa da CEF, com base nas informações dos $`r n_recentes`$ últimos concursos (excluindo os concursos da virada, que têm arrecadações atípicas).

Este gráfico mostra as distâncias entre as arrecadações reais (os pontos) e as estimativas do nosso modelo (representadas pela reta azul). A área sombreada mostra um intervalo de confiança de $95\%$:

```{r}
previsoes %>% 
  ggplot(aes(x = est_arrec)) +
    geom_ribbon(
      aes(ymin = .pred_lower, ymax = .pred_upper), 
      fill = 'light blue',
      alpha = .3
    ) +
    geom_line(aes(y = .pred), color = 'blue', size = 1) +
    geom_line(aes(y = est_arrec), color = 'gray', size = 1) +
    geom_point(aes(y = arrec)) +
    labs(
      title = glue(
        'Nosso modelo para a arrecadação (azul)',
        '\nnos últimos {n_recentes} concursos'
      ),
      subtitle = 'com base nas estimativas da CEF (cinza)', 
      x = 'Estimativa da CEF',
      y = 'Arrecadação'
    ) +
    scale_x_continuous(
      labels = scales::label_dollar(suffix = 'M', big.mark = ' ')
    ) +
    scale_y_continuous(
      labels = scales::label_dollar(suffix = 'M', big.mark = ' ')
    )
```

O gráfico mostra que as estimativas da CEF costumam ser mais baixas do que as arrecadações reais. Nosso modelo corrige esta tendência. 

::: {.rmdimportant}

### Conclusão {-}

A arrecadação real e a estimativa da CEF estão relacionadas, *em média*, pela equação
$$
\text{arrecadação} = `r b0` + `r b1` \times \text{estimativa}
$$
com arrecadação e estimativa em milhões de reais.

:::

Nosso modelo (como qualquer outro) não é perfeito --- a reta não passa por todos os pontos --- mas ele dá conta de $`r (rsq %>% round(3) * 100) %>% fm()`\%$ da variação das arrecadações; i.e., $R^2 = `r rsq %>% round(3) %>% fm()`$. Em comparação, as estimativas da CEF tinham $R^2 = `r rsq_CEF %>% round(3) %>% fm()`$.

Eis um gráfico comparando as estimativas mais recentes do nosso modelo com a arrecadação real e as estimativas da CEF:

```{r}
previsoes %>% 
  ggplot(aes(x = data)) +
    geom_line(aes(y = arrec, color = 'Arrecadação real'), size = 1) +
    geom_line(aes(y = .pred, color = 'Nossa estimativa'), size = 1) +
    geom_line(aes(y = est_arrec, color = 'Estimativa da CEF'), size = 1) +
    scale_color_hue() +
    scale_y_continuous(
      labels = scales::label_dollar(suffix = 'M', big.mark = ' '),
      limits = c(0, NA)
    ) +
    labs(
      title = glue(
        'Nossa estimativa para a arrecadação nos últimos {n_previsoes} concursos',
      ),
      subtitle = 'em comparação com a arrecadação real e a estimativa da CEF',
      x = NULL,
      y = NULL,
      color = NULL
    ) +
    theme(legend.position = 'bottom')
```


## Estimando ganhadores da quina

```{r}
loadd(quina_resultados, n_recentes)

previsoes <- quina_resultados$validacao
modelo <- quina_resultados$modelo %>% pull_workflow_fit()

b0 <- modelo$fit$coefficients[1] %>% round(2) %>% fm()
b1 <- modelo$fit$coefficients[2] %>% round(2) %>% fm()

n_previsoes <- nrow(previsoes)
rsq <- previsoes %>% 
  metrics(truth = g_quina, estimate = .pred) %>% 
  filter(.metric == 'rsq') %>% 
  pull(.estimate)
```

É razoável que, quanto maior a arrecadação, maior a quantidade de jogadores e maior a quantidade de ganhadores da quina.

O gráfico abaixo mostra um modelo linear para o número de ganhadores da quina com base na estimativa de arrecadação da CEF. O modelo dá conta de $`r (rsq %>% round(3) * 100) %>% fm()`\%$ da variação no número de ganhadores.

```{r}
previsoes %>% 
  ggplot(aes(x = est_arrec)) +
    geom_ribbon(
      aes(ymin = .pred_lower, ymax = .pred_upper), 
      fill = 'light blue',
      alpha = .3
    ) +
    geom_line(aes(y = .pred), color = 'blue', size = 1) +
    geom_point(aes(y = g_quina)) +
    labs(
      title = glue(
        'Nosso modelo para ganhadores da quina',
        '\nnos últimos {n_previsoes} concursos'
      ),
      subtitle = 'com base nas estimativas da CEF',
      x = 'Estimativa da CEF',
      y = 'Ganhadores'
    ) +
    scale_x_continuous(
      labels = scales::label_dollar(suffix = 'M', big.mark = ' ')
    )
```

::: {.rmdimportant}

### Conclusão {-}

O número de ganhadores da quina e a estimativa da CEF estão relacionadas, *em média*, pela equação
$$
\text{ganhadores da quina} = `r b0` + `r b1` \times \text{estimativa}
$$
com estimativa em milhões de reais.

:::


## Estimando ganhadores da quadra

```{r}
loadd(quadra_resultados, n_recentes)

previsoes <- quadra_resultados$validacao
modelo <- quadra_resultados$modelo %>% pull_workflow_fit()

b0 <- modelo$fit$coefficients[1] %>% round(2) %>% fm()
b1 <- modelo$fit$coefficients[2] %>% round(2) %>% fm()

n_previsoes <- nrow(previsoes)
rsq <- previsoes %>% 
  metrics(truth = g_quadra, estimate = .pred) %>% 
  filter(.metric == 'rsq') %>% 
  pull(.estimate)
```

O mesmo raciocínio se aplica ao número de ganhadores da quadra.

O gráfico abaixo mostra um modelo linear para o número de ganhadores da quadra com base na estimativa de arrecadação da CEF. O modelo dá conta de $`r (rsq %>% round(3) * 100) %>% fm()`\%$ da variação no número de ganhadores.

```{r}
previsoes %>% 
  ggplot(aes(x = est_arrec)) +
    geom_ribbon(
      aes(ymin = .pred_lower, ymax = .pred_upper), 
      fill = 'light blue',
      alpha = .3
    ) +
    geom_line(aes(y = .pred), color = 'blue', size = 1) +
    geom_point(aes(y = g_quadra)) +
    labs(
      title = glue(
        'Nosso modelo para ganhadores da quadra',
        '\nnos últimos {n_previsoes} concursos'
      ),
      subtitle = 'com base nas estimativas da CEF',
      x = 'Estimativa da CEF',
      y = 'Ganhadores'
    ) +
    scale_x_continuous(
      labels = scales::label_dollar(suffix = 'M', big.mark = ' ')
    )
```

::: {.rmdimportant}

### Conclusão {-}

O número de ganhadores da quadra e a estimativa da CEF estão relacionadas, *em média*, pela equação
$$
\text{ganhadores da quadra} = `r b0` + `r b1` \times \text{estimativa}
$$
com estimativa em milhões de reais.

:::


# Estimando rateios 

```{r}
loadd(df_regress, df_vetor)
```

## Sena

```{r}
df_vetor %>% 
  count(g_sena)
```

```{r}
df_regress %>% 
  ggplot(aes(x = est_arrec, y = r_sena)) +
    geom_point(alpha = .5) +
    scale_x_continuous(labels = scales::dollar_format(suffix = 'M')) +
    scale_y_continuous(
      labels = scales::dollar_format(
        big.mark = '.', 
        decimal.mark = ',',
        scale = 1e-6,
        suffix = 'M'
      )
    ) +
    geom_smooth(method = 'lm', se = FALSE, formula = y ~ x) +
    labs(
      title = glue(
        'Valor do prêmio individual da sena',
        '\nnos últimos {n_recentes} concursos'
      ),

      subtitle = 'em função da arrecadação estimada',
      y = 'prêmio\nindividual',
      x = 'arrecadação estimada'
    )
```

## Quina e quadra

Para prever os valores dos prêmios individuais da quadra e da quina, o ideal seria achar um modelo dos rateios em função da arrecadação estimada.

Uma idéia razoável é que, quanto maior a arrecadação total, maior o número de ganhadores e, daí, menor o valor do rateio.

Mas, quando vemos os gráficos, percebemos que isto não é verdade.

Para a quina:

```{r}
df_regress %>% 
  ggplot(aes(x = est_arrec, y = r_quina)) +
    geom_point(alpha = .5) +
    scale_x_continuous(labels = scales::dollar_format(suffix = 'M')) +
    scale_y_continuous(
      labels = scales::dollar_format(big.mark = '.', decimal.mark = ',')
    ) +
    geom_smooth(method = 'lm', se = FALSE, formula = y ~ x) +
    labs(
      title = 'Valor do prêmio individual da quina',
      subtitle = 'em função da arrecadação estimada',
      y = 'prêmio\nindividual',
      x = 'arrecadação estimada'
    )
```

A reta mostra que, em média, o valor do rateio da quina praticamente *não muda* em função da arrecadação estimada.

Algo parecido acontece com o valor do prêmio individual da quadra:

```{r}
df_regress %>% 
  ggplot(aes(x = est_arrec, y = r_quadra)) +
    geom_point(alpha = .5) +
    scale_x_continuous(labels = scales::dollar_format(suffix = 'M')) +
    scale_y_continuous(
      labels = scales::dollar_format(big.mark = '.', decimal.mark = ',')
    ) +
    geom_smooth(method = 'lm', se = FALSE, formula = y ~ x) +
    labs(
      title = 'Valor do prêmio individual da quadra',
      subtitle = 'em função da arrecadação estimada',
      y = 'prêmio\nindividual',
      x = 'arrecadação estimada'
    )
```

# Previsões

