---
title: 'An√°lise Explorat√≥ria'
subtitle: 'Megasena'
author: 'fnaufel'
email: 'https://fnaufel.github.io/'
date: 'Vers√£o de `r format(Sys.Date(), "%d/%m/%Y")`'
lang: 'pt'
# TODO: include LaTeX fields
output: 
  html_document:
    theme: readable
           # https://bootswatch.com/3/readable/
    highlight: tango
    css: styles.css
    toc: true
    toc_depth: 2
    number_sections: true
    fig_width: 7
    fig_height: 5
    fig_caption: true
    df_print: kable
    self_contained: true
    # code_folding: show
    # keep_md: true
    # includes:
    #   in_header: header.html
    #   before_body: doc_prefix.html
    #   after_body: doc_suffix.html
---

```{r setup, include=FALSE}
library(knitr)

opts_chunk$set(
  echo = TRUE, 
  # collapse = TRUE,
  # cache = TRUE,
  out.width = "70%",
  fig.align = 'center',
  fig.width = 6,
  fig.asp = 0.618,  # 1 / phi
  fig.show = "hold"
)

options(dplyr.print_min = 6, dplyr.print_max = 6)

# Supress crayon output
options(crayon.enabled = FALSE)

#library()

# For nice tables
library(gt)

# For nice dataframe summaries
library(summarytools)
st_options(
  plain.ascii = FALSE,
  dfSummary.varnumbers = FALSE,
  dfSummary.style = 'grid',
  dfSummary.graph.magnif = .75
)

# Tidy!
library(tidyverse)

# Sober theme for ggplot
theme_set(
  theme_linedraw() +                         # Set simple theme for ggplot
    theme(                                   # with some tweaks
      axis.title.y.left = element_text(
         angle = 0,                          # Never rotate y axis title
         margin = margin(r = 20),            # Separate y axis title a little 
         vjust = .5                          # Leave y axis title in the middle
      ),
      axis.title.x.bottom = element_text(
         margin = margin(t = 20)             # Separate x axis title a little 
      ),
      axis.line = element_blank(),           # No axis lines
      panel.border = element_blank(),        # No frame
      panel.grid.minor = element_blank()     # No grid minor lines
    )
)

# Avoid scientific notation and use a comma as decimal separator
options(
  scipen = 15,
  OutDec = ','
)

# Format a number with thousand separators (default point)
# and decimal comma enclosed in curly braces for LaTeX printing.
# CAREFUL: if called outside math mode, will print the braces!
fm <- function(x, big = '.', decimal = '{,}') {
  if (!is.numeric(x)) {
    x
  } else {
    prettyNum(x, big.mark = big, decimal.mark = decimal)
  }

}

# To center the results of a chunk (image, video etc.)
# Usage: 
#         out.extra=center()
#         
center <- function(){
  
  if (is_html_output()) {
    'class="center"'
  }
  
}


# To embed YT videos in HTML and the link (centered) in LaTeX
embed_yt <- function(code) {

  if (is_html_output()) {
    include_url(
      paste0(
        'https://www.youtube.com/embed/',
        code
      )
    )
  } else {
    cat(
      paste0(
        '```{=latex}\n',
        '\\begin{center} \\url{https://youtu.be/',
        code,
        '} \\end{center}\n',
        '```'
      )
    )
  }
  
}

```

```{js javascript-init, echo=FALSE}

// Make off-site links open in a new window/tab
function changeTargets() {
  $("a").attr(
    "target", function() {
      // Load local links locally
      if (this.host == location.host) return "_self"
      // Load off-site links in a new window
      else return "_blank";
    }
  );
}

// Execute when document is ready
$(
  changeTargets
)
```


```{r echo=FALSE, message=FALSE}
library(drake)
loadd(df)
loadd(df_summary)
```


# Dicion√°rio

`num`

  : n√∫mero do concurso

`data`

  : data do concurso

`d1 ... d5`

  : dezenas sorteadas
  
`arrec`

  : arrecada√ß√£o total
  
`g_sena, g_quina, g_quadra`

  : quantidades de ganhadores
  
`r_sena, r_quina, r_quadra`

  : rateios para cada faixa, i.e., valor de cada pr√™mio *individual* na faixa
  
`acumulou`

  : `true` se o pr√™mio da sena acumulou
  
`valor_ac`

  : valor acumulado
  
`est_prox`

  : estimativa do pr√™mio *total* da sena no pr√≥ximo concurso
  
`ac_virada`

  : valor acumulado at√© agora para a mega-sena da virada
  

# Estat√≠sticas

```{r echo=FALSE}
df_summary%>% print(method = 'render')
```

# Dezenas sorteadas

::: {.rmdwarning}

Cada sorteio √© independente, e a [Lei dos Grandes N√∫meros](https://pt.wikipedia.org/wiki/Lei_dos_grandes_n%C3%BAmeros) s√≥ diz respeito ao comportamento dos resultados quando o n√∫mero de sorteios *tende ao infinito*. At√© agora, houve $`r df %>% nrow() %>% fm()`$ sorteios, uma quantidade infinitamente menor do que infinitos sorteios. üòú

As informa√ß√µes desta se√ß√£o s√£o apenas curiosidades. 

:::

## Frequ√™ncia

```{r echo=FALSE}
dezenas <- tibble(
  dezena = c(
    df %>% pull(d1),
    df %>% pull(d2),
    df %>% pull(d3),
    df %>% pull(d4),
    df %>% pull(d5),
    df %>% pull(d6)
  )
)
```


```{r echo=FALSE}
nsorteios <- nrow(df)
media <- nsorteios / 10

dezenas %>% 
  ggplot(aes(dezena)) + 
    geom_histogram(binwidth = 1, fill = 'light gray', color = 'black') +
    geom_hline(aes(yintercept = media), color = 'red') +
    labs(
      y = NULL,
      title = paste0(
        'Frequ√™ncia de cada dezena ap√≥s ',
        nsorteios,
        ' sorteios'
      ),
      subtitle = 'frequ√™ncia te√≥rica (uniforme) em vermelho'
    ) +
    scale_x_continuous(breaks = c(1, c(seq(0, 60, 5))[-1]))
```

Todas as dezenas j√° foram sorteadas alguma vez.


## Experimento: jogando as dezenas que menos sa√≠ram

Um erro comum √© achar que as dezenas que foram menos sorteadas em concursos anteriores t√™m probabilidade maior de sair no pr√≥ximo concurso.

```{r echo=FALSE}
loadd(df_sucessos_raras, n_raras)
n_concursos <- nrow(df_sucessos_raras)
```

Em uma simula√ß√£o, jogamos, em cada concurso, as $`r n_raras`$ dezenas que tinham a menor frequ√™ncia acumulada em todos os concursos anteriores. As quantidades de acertos em $`r n_concursos %>% fm()`$ concursos foram:

```{r echo=FALSE}
df_sucessos_raras %>% 
  count(n_acertos)
```

```{r echo=FALSE}
loadd(mesmas_dezenas, df_sucessos_mesmas)
dezenas <- mesmas_dezenas$dezenas[[1]]
```

Para comparar, eis os n√∫meros de acertos se jogarmos as mesmas $`r n_raras`$ dezenas ($`r sort(dezenas)`$) em todos os concursos:

```{r echo=FALSE}
df_sucessos_mesmas %>% 
  count(n_acertos)
```


# Arrecada√ß√£o √© soma de (rateios $\times$ ganhadores)?

N√£o.

Como explicado [no site da CEF](http://loterias.caixa.gov.br/wps/portal/loterias/landing/megasena), a quantidade de pr√™mios que cada ganhador recebe depende da quantidade de n√∫meros que ele apostou. Os dados n√£o incluem esta informa√ß√£o.


# Comportamento da arrecada√ß√£o

Os dados s√≥ cont√™m o valor da arrecada√ß√£o total sem interrup√ß√£o a partir do concurso $1077$, de maio de $2009$.

```{r echo=FALSE}
df_arrec <- df %>% 
  select(num, data, arrec) %>% 
  filter(num >= 1077)
```

```{r echo=FALSE}
df_arrec %>% 
  ggplot(aes(data, arrec)) +
    geom_line() +
    scale_x_date(
      date_breaks = '1 year',
      date_labels = '%Y'
    ) +
    scale_y_continuous(
      labels = scales::label_dollar(
        scale = 1e-6,
        suffix = 'M',
        big.mark = '.',
        decimal.mark = ','
      )
    ) +
    labs(
      title = 'Arrecada√ß√£o total ao longo dos anos',
      x = NULL,
      y = NULL
    )
```

Por ano:

```{r echo=FALSE}
yearly_plot <- function(this_year, df) {
  
  p <- df %>% 
    filter(lubridate::year(data) == this_year) %>% 
    ggplot(aes(data, arrec)) +
      geom_line() +
      scale_x_date(
        date_breaks = '1 month',
        date_labels = '%b'
      ) +
      scale_y_continuous(
        limits = c(0, 1200e6),
        labels = scales::label_dollar(
          scale = 1e-6,
          suffix = 'M',
          big.mark = '.',
          decimal.mark = ','
        )
      ) +
      labs(
        title = glue::glue('\n\nArrecada√ß√£o total em {this_year}'),
        x = NULL,
        y = NULL
      )
  
  print(p)

}

anos <- 2009:2020

walk(anos, yearly_plot, df)
```

Observa√ß√µes:

* Em $2020$, a arrecada√ß√£o m√°xima (na virada) foi mais do que o dobro da arrecada√ß√£o m√°xima de $2009$.

* Houve picos em novembro de $2015$ e em maio de $2019$.

* Em $25/11/2015$, o pr√™mio estava acumulado por $10$ concursos seguidos.

* Em $11/05/2019$, o pr√™mio estava acumulado por $14$ concursos seguidos.


# Sequ√™ncias de pr√™mios acumulados

```{r echo=FALSE}
rl <- rle(df$acumulou)
n_acs <- map(rl$lengths, ~c(rep(0, .x - 1), .x)) %>% unlist()

df %>% 
  mutate(acs = n_acs) %>% 
  filter(acumulou == TRUE & arrec > 0) %>% 
  select(num, data, acs, arrec) %>% 
  arrange(desc(acs)) %>% 
  head(10)
```



# N√∫mero de ganhadores de acordo com arrecada√ß√£o

## Em geral

## Sem pr√™mio acumulado

## Com pr√™mio acumulado

# Quanto um ganhador da sena recebe?

## Em geral

## Sem pr√™mio acumulado

## Com pr√™mio acumulado

# Quanto um ganhador da quina recebe?

## Em geral

## Sem pr√™mio acumulado

## Com pr√™mio acumulado

# Quanto um ganhador da quadra recebe?

## Em geral

## Sem pr√™mio acumulado

## Com pr√™mio acumulado

