---
title: 'An√°lise Explorat√≥ria'
subtitle: 'Megasena'
author: 'fnaufel'
email: 'https://fnaufel.github.io/'
date: 'Vers√£o de `r format(Sys.Date(), "%d/%m/%Y")`'
lang: 'pt'
# TODO: include LaTeX fields
output: 
  html_document:
    theme: readable
           # https://bootswatch.com/3/readable/
    highlight: tango
    css: styles.css
    toc: true
    toc_depth: 2
    number_sections: true
    fig_width: 7
    fig_height: 5
    fig_caption: true
    df_print: paged
    self_contained: true
    # code_folding: show
    # keep_md: true
    # includes:
    #   in_header: header.html
    #   before_body: doc_prefix.html
    #   after_body: doc_suffix.html
---

```{r setup, include=FALSE}
library(knitr)

opts_chunk$set(
  echo = TRUE, 
  # collapse = TRUE,
  # cache = TRUE,
  out.width = "70%",
  fig.align = 'center',
  fig.width = 6,
  fig.asp = 0.618,  # 1 / phi
  fig.show = "hold"
)

options(dplyr.print_min = 6, dplyr.print_max = 6)

# Supress crayon output
options(crayon.enabled = FALSE)

#library()

# For nice tables
library(gt)

# For nice dataframe summaries
library(summarytools)
st_options(
  plain.ascii = FALSE,
  dfSummary.varnumbers = FALSE,
  dfSummary.style = 'grid',
  dfSummary.graph.magnif = .75
)

# Tidy!
library(tidyverse)

# Sober theme for ggplot
theme_set(
  theme_linedraw() +                         # Set simple theme for ggplot
    theme(                                   # with some tweaks
      axis.title.y.left = element_text(
         angle = 0,                          # Never rotate y axis title
         margin = margin(r = 20),            # Separate y axis title a little 
         vjust = .5                          # Leave y axis title in the middle
      ),
      axis.title.x.bottom = element_text(
         margin = margin(t = 20)             # Separate x axis title a little 
      ),
      axis.line = element_blank(),           # No axis lines
      panel.border = element_blank(),        # No frame
      panel.grid.minor = element_blank()     # No grid minor lines
    )
)

# Avoid scientific notation and use a comma as decimal separator
options(
  scipen = 15,
  OutDec = ','
)

# Format a number with thousand separators (default point)
# and decimal comma enclosed in curly braces for LaTeX printing.
# CAREFUL: if called outside math mode, will print the braces!
fm <- function(x, big = '.', decimal = '{,}') {
  if (!is.numeric(x)) {
    x
  } else {
    prettyNum(x, big.mark = big, decimal.mark = decimal)
  }

}

# To center the results of a chunk (image, video etc.)
# Usage: 
#         out.extra=center()
#         
center <- function(){
  
  if (is_html_output()) {
    'class="center"'
  }
  
}


# To embed YT videos in HTML and the link (centered) in LaTeX
embed_yt <- function(code) {

  if (is_html_output()) {
    include_url(
      paste0(
        'https://www.youtube.com/embed/',
        code
      )
    )
  } else {
    cat(
      paste0(
        '```{=latex}\n',
        '\\begin{center} \\url{https://youtu.be/',
        code,
        '} \\end{center}\n',
        '```'
      )
    )
  }
  
}

```

```{js javascript-init, echo=FALSE}

// Make off-site links open in a new window/tab
function changeTargets() {
  $("a").attr(
    "target", function() {
      // Load local links locally
      if (this.host == location.host) return "_self"
      // Load off-site links in a new window
      else return "_blank";
    }
  );
}

// Execute when document is ready
$(
  changeTargets
)
```


```{r echo=FALSE, message=FALSE}
library(drake)
loadd(df)
loadd(df_summary)
```


# Dicion√°rio

`num`

  : n√∫mero do concurso

`data`

  : data do concurso

`d1 ... d5`

  : dezenas sorteadas
  
`arrec`

  : arrecada√ß√£o total
  
`g_sena, g_quina, g_quadra`

  : quantidades de ganhadores
  
`r_sena, r_quina, r_quadra`

  : rateios para cada faixa, i.e., valor de cada pr√™mio *individual* na faixa
  
`acumulou`

  : `true` se o pr√™mio da sena acumulou
  
`valor_ac`

  : valor acumulado
  
`est_prox`

  : estimativa do pr√™mio *total* da sena no pr√≥ximo concurso
  
`ac_virada`

  : valor acumulado at√© agora para a mega-sena da virada
  

# Estat√≠sticas

```{r echo=FALSE}
df_summary%>% print(method = 'render')
```

# Dezenas sorteadas

::: {.rmdwarning}

Cada sorteio √© independente, e a [Lei dos Grandes N√∫meros](https://pt.wikipedia.org/wiki/Lei_dos_grandes_n%C3%BAmeros) s√≥ diz respeito ao comportamento dos resultados quando o n√∫mero de sorteios *tende ao infinito*. At√© agora, houve $`r df %>% nrow() %>% fm()`$ sorteios, uma quantidade infinitamente menor do que infinitos sorteios. üòú

As informa√ß√µes desta se√ß√£o s√£o apenas curiosidades. 

:::

## Frequ√™ncia

```{r echo=FALSE}
dezenas <- tibble(
  dezena = c(
    df %>% pull(d1),
    df %>% pull(d2),
    df %>% pull(d3),
    df %>% pull(d4),
    df %>% pull(d5),
    df %>% pull(d6)
  )
)
```


```{r echo=FALSE}
nsorteios <- nrow(df)
media <- nsorteios / 10

dezenas %>% 
  ggplot(aes(dezena)) + 
    geom_histogram(binwidth = 1, fill = 'light gray', color = 'black') +
    geom_hline(aes(yintercept = media), color = 'red') +
    labs(
      y = NULL,
      title = paste0(
        'Frequ√™ncia de cada dezena ap√≥s ',
        nsorteios,
        ' sorteios'
      ),
      subtitle = 'frequ√™ncia te√≥rica (uniforme) em vermelho'
    ) +
    scale_x_continuous(breaks = c(1, c(seq(0, 60, 5))[-1]))
```

Todas as dezenas j√° foram sorteadas alguma vez.


## Experimento: jogando as dezenas que menos sa√≠ram

Um erro comum √© achar que as dezenas que foram menos sorteadas em concursos anteriores t√™m probabilidade maior de sair no pr√≥ximo concurso.

```{r echo=FALSE}
loadd(df_sucessos_raras, n_raras)
n_concursos <- nrow(df_sucessos_raras)
```

Em uma simula√ß√£o, jogamos, em cada concurso, as $`r n_raras`$ dezenas que tinham a menor frequ√™ncia acumulada em todos os concursos anteriores. As quantidades de acertos em $`r n_concursos %>% fm()`$ concursos foram:

```{r echo=FALSE}
df_sucessos_raras %>% 
  count(n_acertos)
```

```{r echo=FALSE}
loadd(mesmas_dezenas, df_sucessos_mesmas)
dezenas <- mesmas_dezenas$dezenas[[1]]
```

Para comparar, eis os n√∫meros de acertos se jogarmos as mesmas $`r n_raras`$ dezenas ($`r sort(dezenas)`$) em todos os concursos:

```{r echo=FALSE}
df_sucessos_mesmas %>% 
  count(n_acertos)
```


# Arrecada√ß√£o √© soma de (rateios $\times$ ganhadores)?

N√£o.

Como explicado [no site da CEF](http://loterias.caixa.gov.br/wps/portal/loterias/landing/megasena), a quantidade de pr√™mios que cada ganhador recebe depende da quantidade de n√∫meros que ele apostou. Os dados n√£o incluem esta informa√ß√£o.

Pelos dados, no ano de 2020:

```{r echo=FALSE}
percentuais <- df %>% 
  filter(arrec > 0) %>% 
  transmute(
    num = num,
    data = data,
    prop_sena   = round(100 * (r_sena * g_sena) / arrec    , 2),
    prop_quina  = round(100 * (r_quina * g_quina) / arrec  , 2),
    prop_quadra = round(100 * (r_quadra * g_quadra) / arrec, 2)
  )

quadra <- percentuais %>% 
  filter(lubridate::year(data) == 2020) %>% 
  count(prop_quadra) %>% 
  pull(prop_quadra)

quina <- percentuais %>% 
  filter(lubridate::year(data) == 2020) %>% 
  count(prop_quina) %>% 
  pull(prop_quina)

sena <- percentuais %>% 
  filter(lubridate::year(data) == 2020 & prop_sena > 0) %>% 
  count(prop_sena) 
```

* [O percentual da arrecada√ß√£o destinado aos ganhadores da quina foi $`r quina %>% fm()`$.]{.hl}

* [O percentual da arrecada√ß√£o destinado aos ganhadores da quadra foi $`r quadra %>% fm()`$.]{.hl}

* O percentual da arrecada√ß√£o destinado aos ganhadores da sena variou loucamente (incluindo percentuais maiores do que $100\%$):

```{r echo=FALSE}
sena
```


# N√∫mero de ganhadores de acordo com arrecada√ß√£o

O objetivo final √© calcular o valor esperado da receita. J√° sabemos o *percentual* da arrecada√ß√£o destinado aos ganhadores da quina e da quadra. Agora precisamos estimar o *n√∫mero de ganhadores*.

Os dados s√≥ cont√™m o valor da arrecada√ß√£o total sem interrup√ß√£o a partir do concurso $1077$, de maio de $2009$.

```{r echo=FALSE}
loadd(df_ganhadores)
```

Quantidade de ganhadores da sena desde ent√£o:

```{r echo=FALSE}
df_ganhadores %>% 
  count(g_sena)
```

Concursos com $5$ ou mais ganhadores da sena; a maioria na virada:

```{r echo=FALSE}
df_ganhadores %>% 
  filter(g_sena > 4) %>% 
  select(num, data, g_sena)
```

## Ganhadores da quina de acordo com a arrecada√ß√£o

```{r echo=FALSE}
loadd(ano_atual, n_anos, inicio, min_arrec)
```

Vamos considerar apenas os √∫ltimos $`r n_anos`$ anos e arrecada√ß√µes menores que $`r min_arrec %>% fm()`$:

```{r echo=FALSE}
loadd(plot_ganhadores_quina)
plot_ganhadores_quina
```

```{r echo=FALSE}
loadd(lm_quina)
b05 <- lm_quina$coefficients['(Intercept)'] %>% signif(2) %>% fm()
b15 <- lm_quina$coefficients['arrec'] %>% signif(2) %>% fm()
```

Temos a regress√£o [$g5 = `r b05` + `r b15` \cdot \text{arrec}$]{.hl}, onde $g5$ √© o n√∫mero de ganhadores da quina.

## Rateio da quina de acordo com a arrecada√ß√£o

??td?? Podia fazer a regress√£o direto, sem passar pelo n√∫mero de ganhadores!


## Ganhadores da quadra de acordo com a arrecada√ß√£o

Vamos considerar apenas os √∫ltimos $`r n_anos`$ anos e arrecada√ß√µes menores que $`r min_arrec %>% fm()`$:

```{r echo=FALSE}
loadd(plot_ganhadores_quadra)
plot_ganhadores_quadra
```

```{r echo=FALSE}
loadd(lm_quadra)
b04 <- lm_quadra$coefficients['(Intercept)'] %>% signif(2) %>% fm()
b14 <- lm_quadra$coefficients['arrec'] %>% signif(2) %>% fm()
```

Temos a regress√£o [$g4 = `r b04` + `r b14` \cdot \text{arrec}$]{.hl}, onde $g4$ √© o n√∫mero de ganhadores da quadra.

## Rateio da quadra de acordo com a arrecada√ß√£o

