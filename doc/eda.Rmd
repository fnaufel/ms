---
title: 'AnÃ¡lise ExploratÃ³ria'
subtitle: 'Megasena'
author: 'fnaufel'
email: 'https://fnaufel.github.io/'
date: 'VersÃ£o de `r format(Sys.Date(), "%d/%m/%Y")`'
lang: 'pt'
# TODO: include LaTeX fields
output: 
  html_document:
    theme: readable
           # https://bootswatch.com/3/readable/
    highlight: tango
    css: styles.css
    toc: true
    toc_depth: 2
    number_sections: true
    fig_width: 7
    fig_height: 5
    fig_caption: true
    df_print: kable
    self_contained: true
    # code_folding: show
    # keep_md: true
    # includes:
    #   in_header: header.html
    #   before_body: doc_prefix.html
    #   after_body: doc_suffix.html
---

```{r setup, include=FALSE}
library(knitr)

opts_chunk$set(
  echo = TRUE, 
  # collapse = TRUE,
  # cache = TRUE,
  out.width = "70%",
  fig.align = 'center',
  fig.width = 6,
  fig.asp = 0.618,  # 1 / phi
  fig.show = "hold"
)

options(dplyr.print_min = 6, dplyr.print_max = 6)

# Supress crayon output
options(crayon.enabled = FALSE)

#library()

# For nice tables
library(gt)

# For nice dataframe summaries
library(summarytools)
st_options(
  plain.ascii = FALSE,
  dfSummary.varnumbers = FALSE,
  dfSummary.style = 'grid',
  dfSummary.graph.magnif = .75
)

# Tidy!
library(tidyverse)

# Sober theme for ggplot
theme_set(
  theme_linedraw() +                         # Set simple theme for ggplot
    theme(                                   # with some tweaks
      axis.title.y.left = element_text(
         angle = 0,                          # Never rotate y axis title
         margin = margin(r = 20),            # Separate y axis title a little 
         vjust = .5                          # Leave y axis title in the middle
      ),
      axis.title.x.bottom = element_text(
         margin = margin(t = 20)             # Separate x axis title a little 
      ),
      axis.line = element_blank(),           # No axis lines
      panel.border = element_blank(),        # No frame
      panel.grid.minor = element_blank()     # No grid minor lines
    )
)

# Avoid scientific notation and use a comma as decimal separator
options(
  scipen = 15,
  OutDec = ','
)

# Format a number with thousand separators (default point)
# and decimal comma enclosed in curly braces for LaTeX printing.
# CAREFUL: if called outside math mode, will print the braces!
fm <- function(x, big = '.', decimal = '{,}') {
  if (!is.numeric(x)) {
    x
  } else {
    prettyNum(x, big.mark = big, decimal.mark = decimal)
  }

}

# To center the results of a chunk (image, video etc.)
# Usage: 
#         out.extra=center()
#         
center <- function(){
  
  if (is_html_output()) {
    'class="center"'
  }
  
}


# To embed YT videos in HTML and the link (centered) in LaTeX
embed_yt <- function(code) {

  if (is_html_output()) {
    include_url(
      paste0(
        'https://www.youtube.com/embed/',
        code
      )
    )
  } else {
    cat(
      paste0(
        '```{=latex}\n',
        '\\begin{center} \\url{https://youtu.be/',
        code,
        '} \\end{center}\n',
        '```'
      )
    )
  }
  
}

```

```{js javascript-init, echo=FALSE}

// Make off-site links open in a new window/tab
function changeTargets() {
  $("a").attr(
    "target", function() {
      // Load local links locally
      if (this.host == location.host) return "_self"
      // Load off-site links in a new window
      else return "_blank";
    }
  );
}

// Execute when document is ready
$(
  changeTargets
)
```


```{r echo=FALSE, message=FALSE}
library(drake)
loadd(df)
loadd(df_summary)
```


# DicionÃ¡rio

`num`

  : nÃºmero do concurso

`data`

  : data do concurso

`d1 ... d5`

  : dezenas sorteadas
  
`arrec`

  : arrecadaÃ§Ã£o total
  
`g_sena, g_quina, g_quadra`

  : quantidades de ganhadores
  
`r_sena, r_quina, r_quadra`

  : rateios para cada faixa, i.e., valor de cada prÃªmio *individual* na faixa
  
`acumulou`

  : `true` se o prÃªmio da sena acumulou
  
`valor_ac`

  : valor acumulado
  
`est_prox`

  : estimativa do prÃªmio *total* da sena no prÃ³ximo concurso
  
`ac_virada`

  : valor acumulado atÃ© agora para a mega-sena da virada
  

# EstatÃ­sticas

```{r echo=FALSE}
df_summary%>% print(method = 'render')
```

# Dezenas sorteadas

::: {.rmdwarning}

Cada sorteio Ã© independente, e a Lei dos Grandes NÃºmeros sÃ³ diz respeito ao comportamento dos resultados quando o nÃºmero de sorteios *tende ao infinito*. AtÃ© agora, houve $`r df %>% nrow() %>% fm()`$ sorteios, uma quantidade infinitamente menor do que infinitos sorteios. ðŸ˜œ

As informaÃ§Ãµes desta seÃ§Ã£o sÃ£o apenas curiosidades. 

:::

## FrequÃªncia

```{r}
dezenas <- tibble(
  dezena = c(
    df %>% pull(d1),
    df %>% pull(d2),
    df %>% pull(d3),
    df %>% pull(d4),
    df %>% pull(d5),
    df %>% pull(d6)
  )
)
```

Alguma dezena deixou de sair? NÃ£o.

```{r}
n_distinct(dezenas$dezena)
```

```{r}
nsorteios <- nrow(df)
media <- nsorteios / 10

dezenas %>% 
  ggplot(aes(dezena)) + 
    geom_histogram(binwidth = 1, fill = 'light gray', color = 'black') +
    geom_hline(aes(yintercept = media), color = 'red') +
    labs(
      y = NULL,
      title = paste0(
        'FrequÃªncia de cada dezena apÃ³s ',
        nsorteios,
        ' sorteios'
      ),
      subtitle = 'frequÃªncia teÃ³rica (uniforme) em vermelho'
    ) +
    scale_x_continuous(breaks = c(1, c(seq(0, 60, 5))[-1]))
```

## Experimento: jogando as dezenas que menos saÃ­ram

Vamos montar um *data frame* com as frequÃªncias acumuladas de cada dezena atÃ© cada concurso:

```{r}
tabular <- function(resultado) {
  
  vetor <- rep(0, 60)
  names(vetor) <- paste0('d', 1:60)
  
  vetor[resultado] <- 1
  
  list(vetor)
  
}
```

```{r}
df_freqs_ac <- df %>% 
  select(num, d1, d2, d3, d4, d5, d6) %>% 
  
  # criar coluna com vetor das 6 dezenas sorteadas por concurso
  rowwise() %>% 
  transmute(
    num = num,
    resultado = list(c_across(d1:d6))
  ) %>% 
  
  # criar coluna freqs com vetor de 60 posiÃ§Ãµes por concurso 
  # (0 = dezena nÃ£o saiu, 1 = saiu)
  transmute(
    num = num,
    freqs = tabular(resultado)
  ) %>% 
  
  # transformar freqs em 60 colunas
  ungroup() %>%
  unnest_wider(freqs) %>%
  
  # transformar cada coluna em frequÃªncias acumuladas
  transmute(
    num = num,
    across(d1:d60, cumsum)
  ) %>%
  
  # Cada concurso tem uma tibble associada, com 60 linhas: linha n tem a dezena n
  # e a frequÃªncia acumulada (fac) daquela dezena atÃ© o concurso n
  nest(freqs = d1:d60) %>%
  mutate(
    freqs = map(
      .$freqs,
      pivot_longer,
      cols = d1:d60,
      names_to = 'dezena',
      names_prefix = 'd',
      values_to = 'fac'
    )
  )

head(df_freqs_ac, 10)
```

```{r}
df_freqs_ac %>% 
  slice(500) %>% 
  pull(freqs)
```


```{r}
n_historia <- 100
n_raras <- 8

tibble2vec <- function(x) {
  
  pull(x, dezena)[1:n_raras]
  
}

df_raras <- df_freqs_ac %>% 
  
  # Acrescentar uma coluna com uma tibble com as dezenas mais raras (com menores fac) 
  # atÃ© aquele concurso
  slice_tail(n = nrow(.) - n_historia) %>% 
  rowwise() %>% 
  mutate(
    raras = list(
      slice_min(freqs, order_by = fac, n = n_raras) %>% 
        select(dezena) %>% 
        mutate(dezena = as.numeric(dezena)) %>% 
        arrange(dezena)
    ),
    .keep = 'unused'
  ) %>% 
  ungroup() %>% 
  
  # Transformar cada tibble em um vetor
  mutate(raras = map(raras, tibble2vec)) 
```

```{r}
# As dezenas raras vÃ£o ser comparadas com o resultado do concurso seguinte
df_raras <- df_raras %>% 
  mutate(num = num + 1)

df_resultados <- df %>% 
  select(num, d1:d6) %>% 
  rowwise() %>% 
  mutate(
    res = list(c_across(d1:d6)),
    .keep = 'unused'
  ) %>% 
  ungroup() %>%
  slice_tail(n = nrow(.) - n_historia)
    
# Fazer join com os resultados
df_memoria <- df_raras %>% 
  inner_join(
    df_resultados
  )
```

```{r}
df_sucessos <- df_memoria %>% 
  rowwise() %>% 
  mutate(
    n_sucessos = sum(raras %in% res),
    .keep = 'unused'
  ) %>% 
  ungroup()
```

```{r}
df_sucessos %>% 
  ggplot() +
    geom_bar(
      aes(n_sucessos)
    ) +
  labs(
    y = NULL,
    x = 'quantidade de acertos',
    title = paste0(
      'Apostando as ',
      n_raras,
      ' dezenas menos sorteadas atÃ© entÃ£o'
    ),
    subtitle = paste0(
      'resultados baseado nos ',
      nrow(df) - n_historia,
      ' concursos mais recentes'
    )
  )
```

```{r}
df_sucessos %>% 
  count(n_sucessos)
```

??td?? Transformar em funÃ§Ãµes. Refazer com um conjunto de dezenas aleatÃ³rias.









# ArrecadaÃ§Ã£o Ã© soma de (rateios $\times$ ganhadores)?

```{r}
df %>% 
  filter(arrec > 0) %>% 
  mutate(
    pago_sena = g_sena * r_sena,
    pago_quina = g_quina * r_quina,
    pago_quadra = g_quadra * r_quadra,
    diferenca = arrec - pago_quadra - pago_quina - pago_sena
  ) %>% 
  summarize(sum(diferenca == 0))
```

NÃ£o.

Como explicado [no site da CEF](http://loterias.caixa.gov.br/wps/portal/loterias/landing/megasena), a quantidade de prÃªmios que cada ganhador recebe depende da quantidade de nÃºmeros que ele apostou. Os dados nÃ£o incluem esta informaÃ§Ã£o.


# Comportamento da arrecadaÃ§Ã£o

# NÃºmero de ganhadores de acordo com arrecadaÃ§Ã£o

## Em geral

## Sem prÃªmio acumulado

## Com prÃªmio acumulado

# Quanto um ganhador da sena recebe?

## Em geral

## Sem prÃªmio acumulado

## Com prÃªmio acumulado

# Quanto um ganhador da quina recebe?

## Em geral

## Sem prÃªmio acumulado

## Com prÃªmio acumulado

# Quanto um ganhador da quadra recebe?

## Em geral

## Sem prÃªmio acumulado

## Com prÃªmio acumulado

